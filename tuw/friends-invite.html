<script src="../Demos/b64.js"></script>
<script src="../LZWEncoder.js"></script>
<script src="../NeuQuant.js"></script>
<script src="../GIFEncoder.js"></script>
<style>
</style>
<body>
    <canvas id="dialogWrapper"></canvas>
    <img id="image">
</body>


<script>

    var getParams = function (url) {
        var params = {};
        var parser = document.createElement('a');
        parser.href = url;
        var query = parser.search.substring(1);
        var vars = query.split('&');
        for (var i = 0; i < vars.length; i++) {
            var pair = vars[i].split('=');
            params[pair[0]] = decodeURIComponent(pair[1]);
        }
        return params;
    };
    var params = getParams(window.location.href);
    var bubbles = decodeURIComponent(atob(params.options)).split(",");

    console.log(bubbles);
    var canvas = document.getElementById('dialogWrapper');
    var context = canvas.getContext('2d');

    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;


    var background = new Image();
    background.src = "assets/tmy-bg.jpg";

    var encoder = new GIFEncoder();
    encoder.setRepeat(0); //auto-loop
    encoder.setDelay(500);
    console.log(encoder.start(), 'start encoder');

    background.onload = function(){
        context.drawImage(background,0,0);
        console.log(this.encoder.addFrame(this.context));   //why encoder.start hasn't started here?
    }

    var speechbubles = [];
    var verticalPos = 100;
    for (var i = 0; i < bubbles.length - 1; i++) {

        speechbubles[i] = new SpeechBuble({
            y: verticalPos,
            dialog: bubbles[i].split("#").join(",")
        });

        verticalPos += 100;
    }

    function SpeechBuble(params) {
        this.x = params.X || 300;
        this.y = params.y || 0;
        this.width = 400;
        this.height = params.height || 50;
        this.fillStyle = params.fillStyle || "#FFFFFF";
        this.strokeStyle = params.strokeStyle || "#000000";
        this.lineWidth = params.lineWidth || 0;
        this.dialog = params.dialog || '';
    }

    function roundRect(ctx, x, y, width, height, radius, fill, stroke) {
        if (typeof stroke == 'undefined') {
            stroke = true;
        }
        if (typeof radius === 'undefined') {
            radius = 5;
        }
        if (typeof radius === 'number') {
            radius = { tl: radius, tr: radius, br: radius, bl: radius };
        } else {
            var defaultRadius = { tl: 0, tr: 0, br: 0, bl: 0 };
            for (var side in defaultRadius) {
                radius[side] = radius[side] || defaultRadius[side];
            }
        }
        ctx.beginPath();
        ctx.moveTo(x + radius.tl, y);
        ctx.lineTo(x + width - radius.tr, y);
        ctx.quadraticCurveTo(x + width, y, x + width, y + radius.tr);
        ctx.lineTo(x + width, y + height - radius.br);
        ctx.quadraticCurveTo(x + width, y + height, x + width - radius.br, y + height);
        ctx.lineTo(x + radius.bl, y + height);
        ctx.quadraticCurveTo(x, y + height, x, y + height - radius.bl);
        ctx.lineTo(x, y + radius.tl);
        ctx.quadraticCurveTo(x, y, x + radius.tl, y);
        ctx.closePath();
        if (fill) {
            ctx.fill();
        }
        if (stroke) {
            ctx.stroke();
        }

    }

    SpeechBuble.prototype.draw = function () {
        if (this.fillStyle) {
            context.fillStyle = this.fillStyle;
            roundRect(context, this.x, this.y, this.width, this.height, 25, true);
            console.log(encoder.addFrame(context));
            context.fillStyle = "#00AF50";
            context.fillText(this.dialog, this.x + 20, this.y + 25);
            console.log(encoder.addFrame(context));
        }

        if (this.strokeStyle && this.lineWidth) {
            context.strokeStyle = this.strokeStyle;
            context.lineWidth = this.lineWidth;
            context.strokeRect(this.x, this.y, this.width, this.height);
        }

    }
    

    for (var i = 0; i < speechbubles.length; ++i) {
        speechbubles[i].draw();
    }

    var cta= new SpeechBuble({
        x: 425,
        y: 600,
        height: 352,
        dialog: 'CTA',
    });
    cta.draw();

    var tuLogo = new Image();
    tuLogo.src = "assets/logo.png";

    tuLogo.onload = function(){
        context.drawImage(tuLogo,425,600,130,130);
        console.log(this.encoder.addFrame(this.context));
    }

    


    encoder.finish();
    document.getElementById('image').src = 'data:image/gif;base64,'+encode64(encoder.stream().getData())

</script>