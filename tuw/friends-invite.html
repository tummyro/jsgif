<script src="../Demos/b64.js"></script>
<script src="../LZWEncoder.js"></script>
<script src="../NeuQuant.js"></script>
<script src="../GIFEncoder.js"></script>
<script src="./js/canvasHelper.js"></script>
<style>
</style>

<body>
    <canvas id="dialogWrapper"></canvas>
    <img id="image">
</body>


<script>

    var getParams = function (url) {
        var params = {};
        var parser = document.createElement('a');
        parser.href = url;
        var query = parser.search.substring(1);
        var vars = query.split('&');
        for (var i = 0; i < vars.length; i++) {
            var pair = vars[i].split('=');
            params[pair[0]] = decodeURIComponent(pair[1]);
        }
        return params;
    };
    var params = getParams(window.location.href);
    var bubbles = decodeURIComponent(atob(params.options)).split(",");

    console.log(bubbles);
    var canvas = document.getElementById('dialogWrapper');
    var context = canvas.getContext('2d');

    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight+200;

 
    context.fillStyle = "rgb(106,195,140)";
    context.fillRect (30, 30, canvas.width, canvas.height);  


    var encoder = new GIFEncoder();
    encoder.setRepeat(0); //auto-loop
    encoder.setDelay(500);
    encoder.start();

    // var background = new Image();
    // background.onload = function () {
    //     console.log(background);
    //     context.drawImage(background, 0, 0, canvas.width, canvas.height);
    //     console.log(canvas.width, canvas.height);
    //     encoder.setSize(canvas.width, canvas.height);
    //     console.log(encoder.addFrame(context, true), 'add frame bg', context);   //why encoder.start hasn't started here?
       
    // }
    // background.src = "assets/tmy-bg.jpg";


    var speechbubles = [];
    var verticalPos = 100;

    for (var i = 0; i < bubbles.length -1; i++) {

        speechbubles[i] = new SpeechBuble({
            y: verticalPos,
            dialog: bubbles[i].split("#").join(",")
        });

        verticalPos += 90;
    }

    function SpeechBuble(params) {
        this.x = params.x || 300;
        this.y = params.y || 0;
        this.width = params.width || 400;
        this.height = params.height || 50;
        this.fillStyle = params.fillStyle || "#FFFFFF";
        this.strokeStyle = params.strokeStyle || "#000000";
        this.lineWidth = params.lineWidth || 0;
        this.dialog = params.dialog || '';
    }


    SpeechBuble.prototype.draw = function () {
        if (this.fillStyle) {
            context.fillStyle = this.fillStyle;
            roundRect(context, this.x, this.y, this.width, this.height, 25,true,false);
            context.fillStyle = '#fff';
            drawArrowhead(context, {x:this.x+200, y:this.y}, {x:this.x+200, y:this.y+54}, 10);
           // console.log(encoder.addFrame(context));
            context.fillStyle = "#000";
            context.font = "18px Arial";
            context.fillText(this.dialog, this.x + 20, this.y + 30);
           // console.log(encoder.addFrame(context));
        }

        if (this.strokeStyle && this.lineWidth) {
            context.strokeStyle = this.strokeStyle;
            context.lineWidth = this.lineWidth;
            context.strokeRect(this.x, this.y, this.width, this.height);
        }

    }

    function finalSpeech() {
        let x = 275;
        let y = 600;
        let height = 100;
        let width= 450;
        let dialog = bubbles[5]; // cta
        context.fillStyle = '#FDD99F';

        roundRect(context, x, y, width, height, 25, true);
        // console.log(encoder.addFrame(context));
        context.fillStyle = "#00AF50";
        context.fillText(dialog, x + 80, y + 50);
    }

    // var tuLogo = new Image();
    // tuLogo.src = "assets/logo.png";

    // tuLogo.onload = function () {
    //     this.context.drawImage(tuLogo, 425, 600, 130, 130);
    //     console.log(this.encoder.addFrame(this.context));
    // }


    for (var i = 0; i < speechbubles.length; ++i) {
        speechbubles[i].draw();
    }

   this.finalSpeech();


   // console.log(encoder.finish(), 'encoder finish');


    document.getElementById('image').src = 'data:image/gif;base64,' + encode64(encoder.stream().getData())

</script>